# 摘要
来自最终用户的DNS查询由递归DNS服务器处理，以实现可扩展性。为了方便起见，当客户端选择默认网络设置时，Internet服务提供商（ISP）会自动为客户端分配递归服务器。但是，用户也应该能够灵活地使用他们首选的递归服务器，比如公共DNS服务器。然而，这种信任可能会被DNS解析路径（我们称之为DNSIntercept）的隐藏拦截破坏。具体来说，在路径上的设备可以欺骗用户指定的DNS服务器的IP地址，并秘密拦截DNS查询，从而导致隐私和安全问题。在本文中，我们对onpath DNS拦截进行了大规模分析，并阐明了其范围和特征。我们设计了新的方法来检测DNS拦截，并利用全球148478个住宅和蜂窝IP地址进行分析。结果，我们发现，在我们检查的3047个As中，259个（8.5%）表现出DNS拦截行为，包括大型提供商，如中国移动。此外，我们发现拦截请求的as的DNS服务器可能使用过时的易受攻击软件（2009年之前已弃用），并且缺乏安全相关功能，例如处理DNSSEC请求。我们的工作突出了路径DNS拦截方面的问题，并为解决此类问题提供了新的见解。   

# 背景
来自客户端的DNS查询由递归名称服务器处理，以提高性能并减少Internet上的流量拥塞。默认情况下用户的递归名称服务器指向ISP操作的服务器。不过呢用户自己也可以根据自己的喜好选择自己的DNS服务器或其他的公共递归权威服务器，比如8.8.8.8，但是呢作者发现存在路径上的设备拦截发送到公共DNS的DNS查询，并秘密的替代递归权威服务器解析的DNS答案进行响应。路径上的设备会伪造响应包，比如把源地址换成用户所指定的解析器的IP地址   
作者认为DNS拦截的目的有（1）打广告、（2）收集统计信息、（3）组织恶意软件连接，但是这么做引发三个方面的担忧（1）拦截未经用户授权，在用户方面很难检测到，这导致了道德问题；（2） 与众所周知的公共DNS服务器相比，用户将解析信任置于替代递归DNS服务器的风险更高，后者通常缺乏适当的维护（例如，配备了过时的DNS软件）；（3） 某些安全相关功能受到影响甚至损坏，例如，某些替代DNS解析器不提供DNSSEC。
### 面临的俩个挑战
1. 获得属于不同自治系统（AS）的客户端进行大规模测试   
2. 如何识别DNS请求到底是发送到了用户指定的递归服务器还是on-path设备指定的替代解析器   
### 主要工作
• 大规模分析了DNS解析路径上的拦截问题，并阐明了范围和特征；   
• 设计了新的方法来检测DNS拦截，并利用全球148,478个固定IP（Residential IP）和移动IP（Cellular IP）地址进行分析；   
• 发现3047个自治系统（AS）中有259个（8.5%）存在DNS拦截现象；   
• 在发生DNS拦截的自治系统中，替代DNS解析器部署了过时的、易受攻击的软件；   
• 调查此问题的严重程度，描述DNS拦截的各个方面，并且检查了对用户的影响；   
• 最终提供了可以缓解此类问题的建议   
### 发现
• 研究了3047个自制系统（AS），259（8.5%）存在DNS拦截，包括中国移动；27%的DNS（Over UDP）请求是被拦截；   
• 用UDP封装的DNS请求以及类型为A的DNS请求容易被拦截；   
• 拦截者用到的DNS服务器安装了过期的软件且容易遭受DOS攻击，另外，57%的DNS服务器不支持DNSSEC；   
• DNS拦截对用户的上网体验并没有显著提升。甚至，用UDP封装的DNS请求，15.37%当发往Public DNS Servers比发往代替DNS服务器的响应更快。   

# 威胁模型
正常响应   
![image](https://user-images.githubusercontent.com/49114842/203557525-e53f7f14-71e7-4b4a-a2e6-edcb8ef50d0f.png)    
威胁模型   
![image](https://user-images.githubusercontent.com/49114842/203557596-c1e80767-050f-4da2-94e1-8c45959b2d5c.png)
普通用户的DNS请求数据包，发往公共DNS服务器，在发往的途中被路径上某个设备重定向或者复制到一个替代解析器，在正常的响应发送回客户端之前，替代解析器将源IP换为原始解析器的IP，并发给客户。在客户的眼里，自然难以识别是否遭到了拦截。DNS拦截有俩个途径一个是重定向，一个是复制。重定向就是把本应该发往原始解析器的包发给了替代解析器，原始解析器收不到这个包并作出响应。复制就是说把本应该发往原始解析器的包复制了一份发给了替代解析器，原始解析器可以收到这个包并作出响应
4种解析路径   
![image](https://user-images.githubusercontent.com/49114842/203680304-2c445931-3f38-4d1f-b797-24af3cba6727.png)
正常模式：到达指定的解析器没有遭到修改，如果是未缓存的域，则会去向对应的权威服务器发起请求。   
请求重定向：删除原本发送给用户指定解析器的原始DNS查询，同时用替代解析器响应这个请求    
请求复制: DNS请求发送到用户指定的解析器，并不修改或阻止，但是该请求会被路径上的设备复制给另一个替代解析器处理，因此权威服务器会受到俩个相同的请求（用户指定的解析器和替代解析器），当收到多个响应时用户通常会接受最快的响应   
直接响应：与请求重定向类似，路径上设备将用户的DNS请求重定向到另一个解析器，而不到达指定的解析器。然而，即使对于未缓存的域，替代解析器也直接响应用户，而无需联系任何其他权威服务器   
# 方法
## 概述
### 测试方法
注册一个域名N，让客户端发送查询N的DNS请求到DNS服务器A   
在权威服务器那一侧记录相关的DNS请求，发现是DNS服务器B发送的查询   
比较A和B，有三种情况   
1，A和B一样，那么就说明这很正常，没什么问题   
2. A和B不一样，且权威服务器这里只收到了一个查询，那么就是重定向    
3. A和B不一样，且权威服务器这里收到了不止一个查询，其中有一个是A，那么就是复制   
### 实验需求
1. 不同客户端的请求域名应该不同，不然的话就会存入缓存中，下次解析器就可能不会去向权威服务器发起访问了   
2. 将客户端请求与权威服务器端收到的查询相关联起来，不这样的话就不知道哪个是哪个了，自然就不知道哪个客户端发起的请求被拦截了，这里用的方法是在查询域名前面加前缀   
3. 客户端应该是多样化的，这里指的是他不仅会在默认的情况下发送到ISP指定的本地DNS服务器，也可以发送DNS请求到指定的DNS解析器，这样可以在同一个客户端探测多个DNS解析器是否发生了DNS劫持   
4. 为了更深入的研究劫持特征，在观测点上需要能够发送多样性的DNS查询包，不同的通讯协议，和不同的RR值。   
5. 公共DNS服务器的IP地址与其出口IP地址的匹配
## 方法
在介绍我们的方法之前，我们首先用拦截器可能考虑的元素来说明拦截模型。在此基础上，我们详细阐述了如何生成DNS请求以及如何识别公共DNS服务的出口IP的方法。
### 拦截模型
作者认为每个DNS包由如下组成
![image](https://user-images.githubusercontent.com/49114842/203779451-bf6556cf-7cd7-492f-aec5-720ab53570c3.png)   
作者构建了一个客户端池，其中包含大量分布在全球的源IP，目标IP指向作者所指定的三个公共DNS解析器（谷歌、OpenDNS、DynamicDNS，EDU（自建的一个DNS 作为比较）），传输协议选了TCP和UDP，5种记录，包括A、AAAA、CNAME、MX和NS。注册了4个域名涵盖了四个顶级域名和一个新的gTLD（com, net, org and club）
### 生成DNS请求
为了解决从客户端发出来的请求和递归服务器发出的请求，这俩个请求包的源ip不一致的问题。作者想到的方法是说构造一个独一无二的请求域名，这样客户端和递归服务器发出的请求包虽然源ip不一样，但是请求的域名是一样且唯一的    
UUID.Google.OurDomain.TLD   
UUID：每个客户端的唯一标识：   
Google：请求的服务器   
OurDomain：注册的域名   
TLD：四个顶级域   
权威那头捕获的域名应该是A类型且与域名前缀的标签匹配
### 生成DNS响应
请求复制的情况：权威服务器的响应里面加了个散列，包含时间戳、源地址、请求的域名
### 确定公共DNS的出口IP
作者需要确认联系他们权威服务器的源ip是否属于公共DNS服务器的，这个源ip也就是出口ip
这个出口IP是单播地址通常与他的任播地址不匹配，这也很好理解，如果用的是任播地址，将会发一堆包，这样会浪费大量的资源。所以作者需要搞清楚这个公共DNS的出口IP是啥。   
过去的研究有说通过IP WHOIS数据和公开信息，可是这些不够准确，作者提出了一个利用DNS的PTR和SOA记录的方法，作者的方法基于一个假设就是说相比于分散的IP地址，公共DNS更倾向于用同一个网段里的IP。为了便于管理，IP地址的身份信息会由网络管理员嵌入在PTR极了和SOA记录里。测了Alexa前12的DNS解析器都是对的，比如说是谷歌的公共DNS的出口IP的反向查询都叫dns-admin.google.com
