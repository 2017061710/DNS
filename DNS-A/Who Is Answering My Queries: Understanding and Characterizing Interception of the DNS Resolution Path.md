# 摘要
来自最终用户的DNS查询由递归DNS服务器处理，以实现可扩展性。为了方便起见，当客户端选择默认网络设置时，Internet服务提供商（ISP）会自动为客户端分配递归服务器。但是，用户也应该能够灵活地使用他们首选的递归服务器，比如公共DNS服务器。然而，这种信任可能会被DNS解析路径（我们称之为DNSIntercept）的隐藏拦截破坏。具体来说，在路径上的设备可以欺骗用户指定的DNS服务器的IP地址，并秘密拦截DNS查询，从而导致隐私和安全问题。在本文中，我们对onpath DNS拦截进行了大规模分析，并阐明了其范围和特征。我们设计了新的方法来检测DNS拦截，并利用全球148478个住宅和蜂窝IP地址进行分析。结果，我们发现，在我们检查的3047个As中，259个（8.5%）表现出DNS拦截行为，包括大型提供商，如中国移动。此外，我们发现拦截请求的as的DNS服务器可能使用过时的易受攻击软件（2009年之前已弃用），并且缺乏安全相关功能，例如处理DNSSEC请求。我们的工作突出了路径DNS拦截方面的问题，并为解决此类问题提供了新的见解。   

# 背景
来自客户端的DNS查询由递归名称服务器处理，以提高性能并减少Internet上的流量拥塞。默认情况下用户的递归名称服务器指向ISP操作的服务器。不过呢用户自己也可以根据自己的喜好选择自己的DNS服务器或其他的公共递归权威服务器，比如8.8.8.8，但是呢作者发现存在路径上的设备拦截发送到公共DNS的DNS查询，并秘密的替代递归权威服务器解析的DNS答案进行响应。路径上的设备会伪造响应包，比如把源地址换成用户所指定的解析器的IP地址   
作者认为DNS拦截的目的有（1）打广告、（2）收集统计信息、（3）组织恶意软件连接，但是这么做引发三个方面的担忧（1）拦截未经用户授权，在用户方面很难检测到，这导致了道德问题；（2） 与众所周知的公共DNS服务器相比，用户将解析信任置于替代递归DNS服务器的风险更高，后者通常缺乏适当的维护（例如，配备了过时的DNS软件）；（3） 某些安全相关功能受到影响甚至损坏，例如，某些替代DNS解析器不提供DNSSEC。
### 面临的俩个挑战
1. 获得属于不同自治系统（AS）的客户端进行大规模测试   
2. 如何识别DNS请求到底是发送到了用户指定的递归服务器还是on-path设备指定的替代解析器   
### 主要工作
• 大规模分析了DNS解析路径上的拦截问题，并阐明了范围和特征；   
• 设计了新的方法来检测DNS拦截，并利用全球148,478个固定IP（Residential IP）和移动IP（Cellular IP）地址进行分析；   
• 发现3047个自治系统（AS）中有259个（8.5%）存在DNS拦截现象；   
• 在发生DNS拦截的自治系统中，替代DNS解析器部署了过时的、易受攻击的软件；   
• 调查此问题的严重程度，描述DNS拦截的各个方面，并且检查了对用户的影响；   
• 最终提供了可以缓解此类问题的建议   
### 发现
• 研究了3047个自制系统（AS），259（8.5%）存在DNS拦截，包括中国移动；27%的DNS（Over UDP）请求是被拦截；   
• 用UDP封装的DNS请求以及类型为A的DNS请求容易被拦截；   
• 拦截者用到的DNS服务器安装了过期的软件且容易遭受DOS攻击，另外，57%的DNS服务器不支持DNSSEC；   
• DNS拦截对用户的上网体验并没有显著提升。甚至，用UDP封装的DNS请求，15.37%当发往Public DNS Servers比发往代替DNS服务器的响应更快。   

# 威胁模型
正常响应   
![image](https://user-images.githubusercontent.com/49114842/203557525-e53f7f14-71e7-4b4a-a2e6-edcb8ef50d0f.png)    
威胁模型   
![image](https://user-images.githubusercontent.com/49114842/203557596-c1e80767-050f-4da2-94e1-8c45959b2d5c.png)
普通用户的DNS请求数据包，发往公共DNS服务器，在发往的途中被路径上某个设备重定向或者复制到一个替代解析器，在正常的响应发送回客户端之前，替代解析器将源IP换为原始解析器的IP，并发给客户。在客户的眼里，自然难以识别是否遭到了拦截。DNS拦截有俩个途径一个是重定向，一个是复制。重定向就是把本应该发往原始解析器的包发给了替代解析器，原始解析器收不到这个包并作出响应。复制就是说把本应该发往原始解析器的包复制了一份发给了替代解析器，原始解析器可以收到这个包并作出响应
### 测试方法
注册一个域名N，让客户端发送查询N的DNS请求到DNS服务器A
在权威服务器那一侧记录相关的DNS请求，发现是DNS服务器B发送的查询
比较A和B，有三种情况
1，A和B一样，那么就说明这很正常，没什么问题
2. A和B不一样，且权威服务器这里只收到了一个查询，那么就是重定向 
3. A和B不一样，且权威服务器这里收到了不止一个查询，其中有一个是A，那么就是复制 
### 数据集来源
